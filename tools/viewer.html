<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>AssistiveCoach – Mock Mirror Viewer</title>
		<style>
			:root {
				--bg: #000;
				--fg: #eaeaea;
				--accent: #00d1ff;
				--ok: #36d399;
				--warn: #fbbf24;
				--off: #6b7280;
				--muted: #bdbdbd;
				--err: #ef4444;
				--ease-soft: cubic-bezier(0.22, 0.61, 0.36, 1);
				--title-size: clamp(48px, 6vw, 64px);
				--body-size: 16px;
				--chip-size: 18px;
			}
			html,
			body {
				margin: 0;
				height: 100%;
				background: var(--bg);
				color: var(--fg);
				font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
					Helvetica, Arial;
			}
			#app {
				position: relative;
				width: 100vw;
				height: 100vh;
				overflow: hidden;
			}
			#overlay {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
				display: block;
			}
			#hud {
				position: absolute;
				left: 2rem;
				bottom: 2rem;
				max-width: min(46ch, 80vw);
				padding: 1rem 1.25rem;
				background: rgba(15, 15, 15, 0.72);
				border: 1px solid rgba(255, 255, 255, 0.12);
				border-radius: 16px;
				backdrop-filter: blur(4px);
			}
			.hud-title {
				font-size: var(--title-size);
				font-weight: 700;
				margin: 0.2rem 0;
				letter-spacing: 0.2px;
			}
			.hud-step {
				opacity: 0.9;
				font-size: 1.2rem;
				margin: 0.2rem 0;
			}
			.hud-subtitle {
				font-size: 1.1rem;
				margin: 0.2rem 0 0.6rem;
				opacity: 0.95;
			}
			.progress-wrap {
				height: 10px;
				background: rgba(255, 255, 255, 0.16);
				border-radius: 999px;
				overflow: hidden;
			}
			.progress {
				height: 100%;
				width: 0%;
				transform-origin: left;
				background: var(--accent);
			}
			.hud-hint {
				margin-top: 0.6rem;
				font-size: 1rem;
				opacity: 0.95;
			}
			#chips {
				position: absolute;
				top: 1rem;
				right: 1rem;
				display: flex;
				gap: 0.5rem;
			}
			.chip {
				padding: 0.35rem 0.7rem;
				border-radius: 999px;
				font-size: 0.85rem;
				border: 1px solid rgba(255, 255, 255, 0.15);
				background: rgba(255, 255, 255, 0.06);
				line-height: 1.1;
			}
			.chip.ok {
				color: #000;
				background: var(--ok);
				border-color: transparent;
			}
			.chip.warn {
				background: rgba(251, 191, 36, 0.18);
				color: #fff;
				border-color: rgba(251, 191, 36, 0.5);
			}
			.chip.off {
				background: rgba(107, 114, 128, 0.25);
				color: #ccc;
				border-color: rgba(255, 255, 255, 0.15);
			}
			.conn {
				position: absolute;
				top: 1rem;
				left: 1rem;
				font-size: 0.95rem;
				opacity: 0.9;
			}
			.ring {
				fill: none;
				stroke: var(--accent);
				stroke-width: 6;
				opacity: 0.9;
			}
			.pulse {
				animation: ringPulse 1.1s var(--ease-soft) infinite;
			}
			@keyframes ringPulse {
				0% {
					transform: scale(1);
					opacity: 0.35;
				}
				50% {
					transform: scale(1.07);
					opacity: 1;
				}
				100% {
					transform: scale(1);
					opacity: 0.35;
				}
			}
			.prefers-reduced-motion * {
				animation: none !important;
				transition: none !important;
			}
			:focus-visible {
				outline: 3px solid var(--accent);
				outline-offset: 3px;
			}
			#banner {
				position: absolute;
				left: 50%;
				top: 0.75rem;
				transform: translateX(-50%);
				background: rgba(0, 0, 0, 0.65);
				padding: 0.55rem 0.9rem;
				border: 1px solid rgba(255, 255, 255, 0.15);
				border-radius: 12px;
				font-size: 0.75rem;
				letter-spacing: 0.3px;
				display: flex;
				gap: 0.75rem;
				align-items: center;
			}
			#banner kbd {
				background: #111;
				padding: 0.25rem 0.45rem;
				border-radius: 6px;
				border: 1px solid rgba(255, 255, 255, 0.3);
				font-size: 0.7rem;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<div class="conn" id="conn">WS: connecting…</div>
			<div id="chips">
				<div
					class="chip off"
					id="chip-cam"
					tabindex="0"
					aria-label="Camera state"
				>
					camera: off
				</div>
				<div
					class="chip"
					id="chip-light"
					tabindex="0"
					aria-label="Lighting state"
				>
					light: unknown
				</div>
			</div>
			<div id="banner" aria-live="polite">
				<span>Shortcuts:</span><kbd>1</kbd><kbd>2</kbd><kbd>3</kbd
				><span>demo steps · Motion: <span id="motion-state">auto</span></span>
			</div>
			<div id="hud" aria-live="polite">
				<div class="hud-title" id="hud-title">Assistive Coach</div>
				<div class="hud-step" id="hud-step">—</div>
				<div class="hud-subtitle" id="hud-subtitle">Waiting for overlay…</div>
				<div class="progress-wrap" aria-label="Progress">
					<div class="progress" id="progress"></div>
				</div>
				<div class="hud-hint" id="hud-hint">
					Tip: run <code>curl -X POST /overlay</code> to send a test overlay.
				</div>
			</div>
			<svg id="overlay" preserveAspectRatio="none" aria-hidden="true"></svg>
		</div>
		<script>
			(function () {
				const qs = new URLSearchParams(location.search);
				let motionForced = qs.get("motion"); // 'off' or 'on'
				const systemReduced = matchMedia(
					"(prefers-reduced-motion: reduce)"
				).matches;
				let reduceMotion = systemReduced || motionForced === "off";
				function applyMotionState() {
					if (reduceMotion)
						document.documentElement.classList.add("prefers-reduced-motion");
					else
						document.documentElement.classList.remove("prefers-reduced-motion");
					document.getElementById("motion-state").textContent = reduceMotion
						? "reduced"
						: "normal";
				}
				applyMotionState();
				const wsParam = new URLSearchParams(location.search).get("ws");
				let WS_URL = wsParam || "ws://localhost:5055/ws";
				// Auto fallback: if served via file:// and default port 5055 isn't up, prefer 127.0.0.1:8000
				if (!wsParam && location.protocol === "file:") {
					WS_URL = "ws://127.0.0.1:8000/ws";
				}
				const conn = document.getElementById("conn");
				const svg = document.getElementById("overlay");
				const title = document.getElementById("hud-title");
				const step = document.getElementById("hud-step");
				const subtitle = document.getElementById("hud-subtitle");
				const hint = document.getElementById("hud-hint");
				const progress = document.getElementById("progress");
				const chipCam = document.getElementById("chip-cam");
				const chipLight = document.getElementById("chip-light");

				function setChip(el, state, text) {
					el.classList.remove("ok", "warn", "off");
					if (state) el.classList.add(state);
					el.textContent = text;
				}
				function drawRing(x, y, r, pulse = true) {
					const c = document.createElementNS(
						"http://www.w3.org/2000/svg",
						"circle"
					);
					c.setAttribute("cx", x);
					c.setAttribute("cy", y);
					c.setAttribute("r", r);
					const doPulse = pulse && !reduceMotion;
					c.setAttribute("class", "ring" + (doPulse ? " pulse" : ""));
					svg.appendChild(c);
				}
				function animateProgress(to01) {
					const v = Math.max(0, Math.min(1, to01));
					progress.style.transform = `scaleX(${v})`;
				}
				function resize() {
					const w = svg.clientWidth,
						h = svg.clientHeight;
					svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
				}
				addEventListener("resize", resize);
				resize();
				let ws,
					pending = null,
					raf = false;
				function flushOverlay(msg) {
					while (svg.firstChild) svg.removeChild(svg.firstChild);
					(msg.shapes || []).forEach((s) => {
						if (s.kind === "ring") {
							const ax = s.anchor?.pixel?.x,
								ay = s.anchor?.pixel?.y;
							if (typeof ax === "number" && typeof ay === "number") {
								drawRing(ax, ay, s.radius_px || 100, true);
							}
						}
						// Future: arrows, badges for accessibility with text labels.
					});
					if (msg.hud) {
						title.textContent = msg.hud.title || "";
						step.textContent = msg.hud.step || "";
						subtitle.textContent = msg.hud.subtitle || "";
						hint.textContent = msg.hud.hint || "";
						const tl = Math.max(0, msg.hud.time_left_s ?? 0);
						const max = msg.hud.max_time_s ?? (tl || 1);
						animateProgress(1 - tl / max);
					}
				}
				function connect() {
					ws = new WebSocket(WS_URL);
					conn.textContent = `WS: connecting… ${WS_URL}`;
					ws.onopen = () => (conn.textContent = "WS: connected");
					ws.onclose = () => {
						conn.textContent = "WS: closed (retry in 2s)";
						setTimeout(connect, 2000);
					};
					ws.onerror = () => {
						conn.textContent = "WS: error (retrying)";
					};
					ws.onmessage = (ev) => {
						let data;
						try {
							data = JSON.parse(ev.data);
						} catch {
							return;
						}
						if (data.type === "overlay.set") {
							pending = data;
							if (!raf) {
								raf = true;
								requestAnimationFrame(() => {
									raf = false;
									flushOverlay(pending);
									pending = null;
								});
							}
						}
						if (data.type === "status") {
							const cam = data.camera ?? "off";
							const light = data.lighting ?? "unknown";
							setChip(chipCam, cam === "on" ? "ok" : "off", `camera: ${cam}`);
							setChip(
								chipLight,
								light === "ok" ? "ok" : light === "dim" ? "warn" : "",
								`light: ${light}`
							);
							if (typeof data.reduce_motion === "boolean") {
								// Respect explicit status setting unless user forced via ?motion
								if (motionForced !== "off" && motionForced !== "on") {
									reduceMotion = systemReduced || data.reduce_motion === true;
									applyMotionState();
								}
							}
						}
					};
				}
				// Keyboard demo overlays (local only)
				function demoOverlay(n) {
					// Reflect realistic HUD phases
					const phases = {
						1: {
							title: "Position Yourself",
							subtitle: "Center face in view",
							hint: "Ensure good lighting",
						},
						2: {
							title: "Find Marker",
							subtitle: "Place tool near mouth",
							hint: "Align until ring turns solid",
						},
						3: {
							title: "Great Job",
							subtitle: "Maintain position",
							hint: "Hold steady for countdown",
						},
					};
					const phase = phases[n] || phases[1];
					flushOverlay({
						type: "overlay.set",
						shapes: [
							{
								kind: "ring",
								anchor: { pixel: { x: 640, y: 360 } },
								radius_px: 100 + 6 * n,
							},
						],
						hud: {
							title: phase.title,
							step: `Step ${n} of 3`,
							subtitle: phase.subtitle,
							time_left_s: 5,
							max_time_s: 5,
							hint: phase.hint,
						},
						_local: true,
					});
				}
				// Toggle motion with keyboard 'm'
				document.addEventListener("keydown", (e) => {
					if (e.key.toLowerCase() === "m") {
						reduceMotion = !reduceMotion;
						applyMotionState();
					}
				});
				document.addEventListener("keydown", (e) => {
					if (["1", "2", "3"].includes(e.key)) {
						demoOverlay(Number(e.key));
					}
				});
				connect();
			})();
		</script>
	</body>
</html>
